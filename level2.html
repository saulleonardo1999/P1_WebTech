<!doctype html>
<html lang="en">
<head>
    <meta charset="UTF-8" />
    <title>Making your first Phaser 3 Game - Part 10</title>
    <script src="//cdn.jsdelivr.net/npm/phaser@3.11.0/dist/phaser.js"></script>
    <script src="https://github.com/photonstorm/phaser/blob/v3.22.0/src/gameobjects/components/Origin.js"></script>
    <script src="https://github.com/photonstorm/phaser/blob/v3.22.0/src/physics/impact/events/PAUSE_EVENT.js"></script>
    <script src="https://github.com/photonstorm/phaser/blob/v3.22.0/src/scene/SceneManager.js"></script>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css"
        integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"
        integrity="sha384-KJ3o2DKtIkvYIK3UENzmM7KCkRr/rE9/Qpg6aAZGJwFDMVNA/GpGFF93hXpG5KkN"
        crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.9/umd/popper.min.js"
        integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q"
        crossorigin="anonymous"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"
        integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl"
        crossorigin="anonymous"></script>
     <script src="https://github.com/photonstorm/phaser/blob/v3.22.0/src/sound/webaudio/WebAudioSoundManager.js"></script>
    <script src="https://github.com/photonstorm/phaser/blob/v2.6.2/src/gameobjects/components/Events.js"></script>
    <style type="text/css">
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<div class="container mx-auto d-block" style="background-color:black;">
        <div id="bloque" class="text-center mx-auto" style="width: 800px; height: 600px; background-color: black;"></div>
 </div>
<script type="text/javascript">

var config = {
    type: Phaser.AUTO,
    width: 800,
    height: 600,
    physics: {
        default: 'arcade',
        arcade: {
            gravity: { y: 300 },
            debug: false
        }
    
    },
    scene: {
        preload: preload,
        create: create,
        update: update
    },
    parent:'bloque'
};

var player;
var band=0;
var count1=0;
var stars;
var starE;
var starE1;
var count=0;
var bombs;
var platforms;
var cursors;
var score = 0;
var gameOver = false;
var scoreText;
var text;
var c =10;
var timedEvent;
var vida = 3;
var vidaText;
var nombre = window.localStorage.getItem('Name');
var nombreText;
var nivel;
var nivelText;
var fondo, bat, batE, h, boom;
    var w = 800, h = 600;

    var game = new Phaser.Game(config);

    var Pausa = new Phaser.Class({
        Extends: Phaser.Scene, initialize:

            function Pausa() {
                Phaser.Scene.call(this, { key: 'pausa' });
            },

        preload: function () {
        },

        create: function () {
            this.add.image(300, 300, 'menuInGame');
            var evtpausa = this;
            this.input.on('pointerdown', function (pointer) {
                if (pointer.x > 0 && pointer.x < 200 && pointer.y > 300 && pointer.y < 500) {
                    evtpausa.scene.stop();
                    evt.scene.resume();
                }
                if (pointer.x > 0 && pointer.x < 200 && pointer.y > 300 && pointer.y < 500) {
                    evtpausa.scene.stop();
                    evt.scene.stop();
                    evt.scene.start('menu');
                }
            });

        }
    });
    //var game = new Phaser.Game(800, 600, Phaser.AUTO, 'arcade', { preload: preload, create: create,update: update });

    function preload ()
    {
        this.load.image('sky', 'assets/gotham.jpg');
        this.load.image('ground', 'assets/platform2.png');
        this.load.image('star', 'assets/star.png');
        this.load.image('bomb', 'assets/bomb.png');
        this.load.image('joker', 'assets/joker.png');
        this.load.image('car', 'assets/batimovil.png');
        this.load.image('pause', 'assets/pause.png');
        this.load.audio('bat','assets/bat.mp3');
        this.load.audio('batE','assets/bativida.mp3');
        this.load.audio('fondo','assets/cancion.mp3');
    this.load.audio('boom','assets/boom.mp3');
        //this.load.image('pause','assets/pause.png');
        this.load.spritesheet('dude', 'assets/dude.png', { frameWidth: 32, frameHeight: 48 });
    }

    function create ()
    {
        //  A simple background for our game
        this.add.image(400, 300, 'sky');
        fondo = this.sound.add('fondo');
    
    //this.input.touch.preventDefault = false;
    //  A simple background for our game
    //fondo.mute= true;
    fondo.play({loop: true});
    boom = this.sound.add('boom');
    bat = this.sound.add('bat');
    batE = this.sound.add('batE');
        //  The platforms    group contains the ground and the 2 ledges we can jump on
        platforms = this.physics.add.staticGroup();
        //  Here we create the ground.
        //  Scale it to fit the width of the game (the original sprite is 400x32 in size)
        platforms.create(400, 600, 'ground').setScale(2).refreshBody();


        //  Now let's create some ledges
        platforms.create(500, 500, 'ground');   //platform 1
        platforms.create(100, 500, 'ground');   //platform 1

        platforms.create(2, 400, 'ground');     //platform 2
        platforms.create(500,400,'ground');     //platform 2
        platforms.create(750,400,'ground');     //platform 2

        platforms.create(500, 300, 'ground');   //platform 3
        platforms.create(100, 300, 'ground');   //platform 3

        platforms.create(2, 200, 'ground');     //platform 4
        //platforms.create(500,200,'ground');     //platform 4
        //platforms.create(750,200,'ground');     //platform 4

        platforms.create(900, 100, 'ground');   //platform 5
        //platforms.create(5, 100, 'ground');     //platform 5
        platforms.create(400,150, 'ground');    //platform 5


        // The player and its settings
        player = this.physics.add.sprite(50, 520, 'dude');

        //  Player physics properties. Give the little guy a slight bounce.
        player.setBounce(0.2);
        player.setCollideWorldBounds(true);


        //  Our player animations, turning, walking left and walking right.
        this.anims.create({
            key: 'left',
            frames: this.anims.generateFrameNumbers('dude', { start: 0, end: 3 }),
            frameRate: 10,
            repeat: -1
        });

        this.anims.create({
            key: 'turn',
            frames: [ { key: 'dude', frame: 4 } ],
            frameRate: 20
        });

        this.anims.create({
            key: 'right',
            frames: this.anims.generateFrameNumbers('dude', { start: 5, end: 8 }),
            frameRate: 10,
            repeat: -1
        });

        //  Input Events


        cursors = this.input.keyboard.createCursorKeys();


        //spaceKey = this.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
        //spaceKey.onDown.add(togglePause, this);

        /*Impresion de los malos y del batimovil */

        bads0 = this.physics.add.group({
            key: 'joker',
            repeat: 0,
            setXY: { x: 750, y: 0, stepX: 50 }
        });

        batimovils = this.physics.add.group({
            key: 'car',
            repeat: 0,
            setXY: { x: 50, y: 520, stepX: 50 }
        });


        /*Impresion de los malos y del batimovil */
        stars = this.physics.add.group({
            key: 'star',
            repeat: 15,
            setXY: { x: 12, y: 200, stepX: 50 }
        });

        stars.children.iterate(function (child) {

            //  Give each star a slightly different bounce
            child.setBounceY(Phaser.Math.FloatBetween(0.4, 0.8));

        });



        bombs = this.physics.add.group();

        scoreText = this.add.text(16, 16, 'score: 0', { fontSize: '32px', fill: '#000' });
    vidaText = this.add.text(600,16, 'vidas: 3',{ fontSize: '32px', fill: '#000' });
    nombreText = this.add.text(16, 56, 'nombre '+ nombre, { fontSize: '32px', fill: '#000' });
    nivelText = this.add.text(600, 56, 'nivel: 1',{ fontSize: '32px', fill: '#000' });



        //  Collide the elements with the platforms
        this.physics.add.collider(player, platforms);
        this.physics.add.collider(stars, platforms);
        this.physics.add.collider(batimovils, platforms);
        this.physics.add.collider(bads0, platforms);
        this.physics.add.collider(bombs, platforms);


        var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);
        /*BOMBAS DESDE EL PRINCIPIO*/

        var bomb = bombs.create(x, 16, 'bomb');
        bomb.setBounce(.8);
        bomb.setCollideWorldBounds(true);
        bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
        bomb.allowGravity = false;

        var bomb0 = bombs.create(x, 16, 'bomb');
        bomb0.setBounce(.8);
        bomb0.setCollideWorldBounds(true);
        bomb0.setVelocity(Phaser.Math.Between(-200, 200), 20);
        bomb0.allowGravity = false;


        /*BOMBAS DESDE EL PRINCIPIO*/

        this.input.on('pointerdown', function (pointer) {
            if (pointer.x > 0 && pointer.x < 595 && pointer.y > 562 && pointer.y < 597) {
                if (!evt.scene.paused){
                    evt.scene.launch('pausa');
                    evt.scene.pause();
                }
            }
        });
        game.scene.pause("default")
        //this.spaceKey = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
        //  Checks to see if the player overlaps with any of the stars, if he does call the collectStar function
        this.physics.add.overlap(player, stars, collectStar, null, this);
        this.physics.add.overlap(player, bads0, busted, null, this);
        this.physics.add.overlap(player,batimovils,win,null,this);

        this.physics.add.collider(player, bombs, hitBomb, null, this);

        var mute_label, resumeM;
    // Create a label to use as a button
    resumeM = this.add.text(700, 200, 'Sonido', { font: '24px Arial', fill: '#fff' });
    this.input.on('pointerdown', function (pointer) {
    if (pointer.x > 700 && pointer.x < 750 && pointer.y > 200 && pointer.y < 220) {
            if (fondo.pause){ 
                fondo.resume();  
                boom.resume();
                bat.resume();
                h=0;
            } 
        }
    });
    mute_label = this.add.text(700, 100, 'Mute', { font: '24px Arial', fill: '#fff' });
    this.input.on('pointerdown', function (pointer) {
        if (pointer.x > 700 && pointer.x < 750 && pointer.y > 100 && pointer.y < 120) {
            if (fondo.play){ 
                fondo.pause();  
                boom.pause();
                bat.pause();
                
                h=1;
            } 
        }

    });
    }

    function update ()
    {
        if (gameOver)
        {

            var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);
            var bomb = bombs.create(x, 16, 'bomb');
            bomb.setBounce(1);
            bomb.setCollideWorldBounds(true);
            bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
            bomb.allowGravity = false;
            player.preload;
            gameOver=false;

            if (vida===0){
                location.replace('gameover.html');
            }
            return;


        }
        if (cursors.left.isDown)
        {
            player.setVelocityX(-160);
            player.clearTint();
            player.anims.play('left', true);
        }
        else if (cursors.right.isDown)
        {
            player.setVelocityX(160);
            player.clearTint();
            player.anims.play('right', true);
        }
        else
        {
            player.setVelocityX(0);

            player.anims.play('turn');
        }

        if (cursors.up.isDown && player.body.touching.down)
        {
            player.setVelocityY(-330);
        }
    }

    function win(player,car) {
        if(score>1000){
            //car.disableBody(true,true);
            this.physics.pause();
            localStorage.setItem('score', score);
            location.replace('menu.html');
        }else{
            this.physics.resume();
        }
    }
    function togglePause() {

        this.physics.arcade.isPaused = (this.physics.arcade.isPaused) ? false : true;

    }

    function collectStar (player, star)
    {
        if(h==1){
            
            bat.pause();
        }else{
            fondo.pause();
            bat.play();
            fondo.resume();
        }
        star.disableBody(true, true);

        //  Add and update the score
        score += 10;
        scoreText.setText('Score: ' + score);

        if (stars.countActive(true) === 0)
        {
            //  A new batch of stars to collect
            stars.children.iterate(function (child) {

                child.enableBody(true, child.x, 0, true, true);

            });

            var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

            var bomb = bombs.create(x, 16, 'bomb');
            bomb.setBounce(1);
            bomb.setCollideWorldBounds(true);
            bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
            bomb.allowGravity = false;


        }
    }
    function busted(player,joker)
    {
        if(h==1){
            
            batE.pause();
        }else{
            fondo.pause();
            batE.play();
            fondo.resume();
        }
        joker.disableBody(true, true);
        //  Add and update the score
        score += 1000;
        scoreText.setText('Score: ' + score);
        if (bads0.countActive(true) === 0)
        {
            //  A new batch of stars to collect


            var x = (player.x < 400) ? Phaser.Math.Between(400, 800) : Phaser.Math.Between(0, 400);

            var bomb = bombs.create(x, 16, 'bomb');
            bomb.setBounce(1);
            bomb.setCollideWorldBounds(true);
            bomb.setVelocity(Phaser.Math.Between(-200, 200), 20);
            bomb.allowGravity = false;

            var bomb0 = bombs.create(x, 16, 'bomb');
            bomb0.setBounce(1);
            bomb0.setCollideWorldBounds(true);
            bomb0.setVelocity(Phaser.Math.Between(-200, 200), 20);
            bomb0.allowGravity = false;



        }

    }


    function pause(player,bomb){
        this.physics.pause();

    }
    function hitBomb (player, bomb)
    {

        bomb.disableBody(true, true);
        player.setTint(0xff0000);
        vida -=1;
        vidaText.setText('Vidas: ' + vida);
        gameOver = true;
        //fondo.stop();
        //boom.play();
        if(h==1){
            
            boom.pause();
        }else{
            fondo.pause();
            boom.play();
            fondo.resume();
        }
    }

</script>

</body>
</html>